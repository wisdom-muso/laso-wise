{% extends 'base.html' %}
{% load static %}
{% load i18n %}

{% block title %}{% trans "Vitals Analytics" %}{% if patient %} - {{ patient.get_full_name }}{% endif %}{% endblock %}

{% block styles %}
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
<style>
    :root {
        --primary-color: #14b8a6;
        --secondary-color: #0d9488;
        --success-color: #10b981;
        --warning-color: #f59e0b;
        --danger-color: #ef4444;
        --info-color: #3b82f6;
        --light-bg: #f8fafc;
        --card-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        --card-shadow-hover: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }

    body {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
    }

    .analytics-container {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border-radius: 20px;
        margin: 20px;
        box-shadow: var(--card-shadow);
        padding: 30px;
    }

    .analytics-card {
        background: white;
        border-radius: 16px;
        box-shadow: var(--card-shadow);
        border: none;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        overflow: hidden;
        position: relative;
        margin-bottom: 24px;
    }

    .analytics-card:hover {
        transform: translateY(-4px);
        box-shadow: var(--card-shadow-hover);
    }

    .analytics-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
    }

    .chart-container {
        position: relative;
        height: 400px;
        margin: 20px 0;
    }

    .metric-card {
        background: white;
        border-radius: 16px;
        padding: 24px;
        box-shadow: var(--card-shadow);
        text-align: center;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }

    .metric-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
    }

    .metric-card:hover {
        transform: translateY(-4px);
        box-shadow: var(--card-shadow-hover);
    }

    .metric-number {
        font-size: 48px;
        font-weight: 700;
        color: var(--primary-color);
        margin-bottom: 8px;
    }

    .metric-label {
        font-size: 16px;
        color: #6b7280;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        font-weight: 500;
    }

    .trend-indicator {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        font-size: 14px;
        font-weight: 500;
        padding: 6px 12px;
        border-radius: 20px;
        margin-top: 8px;
    }

    .trend-up {
        background: #d1fae5;
        color: #065f46;
    }

    .trend-down {
        background: #fee2e2;
        color: #991b1b;
    }

    .trend-stable {
        background: #f3f4f6;
        color: #374151;
    }

    .risk-card {
        background: white;
        border-radius: 12px;
        padding: 16px;
        margin-bottom: 12px;
        border-left: 4px solid var(--danger-color);
        box-shadow: var(--card-shadow);
    }

    .risk-card.warning {
        border-left-color: var(--warning-color);
    }

    .risk-card.info {
        border-left-color: var(--info-color);
    }

    .recommendation-card {
        background: white;
        border-radius: 12px;
        padding: 16px;
        margin-bottom: 12px;
        border-left: 4px solid var(--success-color);
        box-shadow: var(--card-shadow);
    }

    .health-score {
        background: linear-gradient(135deg, var(--success-color), var(--primary-color));
        color: white;
        border-radius: 16px;
        padding: 30px;
        text-align: center;
        margin-bottom: 24px;
    }

    .health-score-number {
        font-size: 72px;
        font-weight: 700;
        margin-bottom: 8px;
    }

    .health-score-label {
        font-size: 18px;
        opacity: 0.9;
    }

    .pattern-analysis {
        background: white;
        border-radius: 16px;
        padding: 24px;
        box-shadow: var(--card-shadow);
        margin-bottom: 24px;
    }

    .pattern-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 0;
        border-bottom: 1px solid #f3f4f6;
    }

    .pattern-item:last-child {
        border-bottom: none;
    }

    .pattern-label {
        font-weight: 500;
        color: #1f2937;
    }

    .pattern-value {
        color: var(--primary-color);
        font-weight: 600;
    }

    .breadcrumb-bar {
        background: white;
        border-radius: 16px;
        margin: 20px;
        padding: 20px;
        box-shadow: var(--card-shadow);
    }

    .breadcrumb-title {
        color: #1f2937;
        font-weight: 600;
        margin: 0;
    }

    .breadcrumb {
        background: none;
        padding: 0;
        margin: 0;
    }

    .breadcrumb-item a {
        color: var(--primary-color);
        text-decoration: none;
        font-weight: 500;
    }

    .breadcrumb-item.active {
        color: #6b7280;
    }

    @media (max-width: 768px) {
        .analytics-container {
            margin: 10px;
            padding: 20px;
        }
        
        .metric-number {
            font-size: 36px;
        }
        
        .health-score-number {
            font-size: 48px;
        }
        
        .chart-container {
            height: 300px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="breadcrumb-bar">
    <div class="container-fluid">
        <div class="row align-items-center">
            <div class="col-md-12">
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="{% url 'core:home' %}">{% trans "Home" %}</a></li>
                        {% if patient %}
                            {% if request.user.role == 'doctor' %}
                            <li class="breadcrumb-item"><a href="{% url 'doctors:my-patients' %}">{% trans "My Patients" %}</a></li>
                            <li class="breadcrumb-item"><a href="{% url 'doctors:patient-detail' patient.id %}">{{ patient.get_full_name }}</a></li>
                            {% else %}
                            <li class="breadcrumb-item"><a href="{% url 'admin-patients' %}">{% trans "Patients" %}</a></li>
                            <li class="breadcrumb-item"><a href="{% url 'admin-patient-detail' patient.id %}">{{ patient.get_full_name }}</a></li>
                            {% endif %}
                        {% else %}
                        <li class="breadcrumb-item"><a href="{% url 'vitals:patient-dashboard' %}">{% trans "Vitals Dashboard" %}</a></li>
                        {% endif %}
                        <li class="breadcrumb-item active">{% trans "Analytics" %}</li>
                    </ol>
                </nav>
                <h2 class="breadcrumb-title">
                    <i class="fas fa-chart-line"></i>
                    {% trans "Advanced Vitals Analytics" %}
                    {% if patient %} - {{ patient.get_full_name }}{% endif %}
                </h2>
            </div>
        </div>
    </div>
</div>

<div class="analytics-container">
    <!-- Health Score Overview -->
    <div class="health-score">
        <div class="health-score-number">{{ analytics.summary.health_score }}</div>
        <div class="health-score-label">{% trans "Health Score" %}</div>
        <small>Based on {{ analytics.summary.total_readings }} readings across {{ analytics.summary.categories_covered }} categories</small>
    </div>

    <!-- Key Metrics -->
    <div class="row">
        <div class="col-md-3 col-sm-6 mb-4">
            <div class="metric-card">
                <div class="metric-number">{{ analytics.summary.total_readings }}</div>
                <div class="metric-label">{% trans "Total Readings" %}</div>
            </div>
        </div>
        <div class="col-md-3 col-sm-6 mb-4">
            <div class="metric-card">
                <div class="metric-number">{{ analytics.summary.categories_covered }}</div>
                <div class="metric-label">{% trans "Categories Covered" %}</div>
            </div>
        </div>
        <div class="col-md-3 col-sm-6 mb-4">
            <div class="metric-card">
                <div class="metric-number">{{ analytics.summary.normal_percentage }}%</div>
                <div class="metric-label">{% trans "Normal Readings" %}</div>
            </div>
        </div>
        <div class="col-md-3 col-sm-6 mb-4">
            <div class="metric-card">
                <div class="metric-number">{{ analytics.risks|length }}</div>
                <div class="metric-label">{% trans "Risk Alerts" %}</div>
            </div>
        </div>
    </div>

    <!-- Trends Analysis -->
    <div class="analytics-card">
        <div class="card-body">
            <h5 class="card-title mb-4">
                <i class="fas fa-trending-up"></i>
                {% trans "Vital Signs Trends" %}
            </h5>
            <div class="row">
                {% for category, trend in analytics.trends.items %}
                <div class="col-md-6 col-lg-4 mb-3">
                    <div class="pattern-analysis">
                        <h6 class="mb-3">{{ category }}</h6>
                        <div class="pattern-item">
                            <span class="pattern-label">{% trans "Change" %}:</span>
                            <span class="pattern-value {% if trend.change_percent > 0 %}text-success{% elif trend.change_percent < 0 %}text-danger{% else %}text-muted{% endif %}">
                                {{ trend.change_percent }}%
                            </span>
                        </div>
                        <div class="pattern-item">
                            <span class="pattern-label">{% trans "Trend" %}:</span>
                            <span class="trend-indicator trend-{% if trend.trend == 'increasing' %}up{% elif trend.trend == 'decreasing' %}down{% else %}stable{% endif %}">
                                <i class="fas fa-arrow-{% if trend.trend == 'increasing' %}up{% elif trend.trend == 'decreasing' %}down{% else %}right{% endif %}"></i>
                                {{ trend.trend|title }}
                            </span>
                        </div>
                        <div class="pattern-item">
                            <span class="pattern-label">{% trans "Range" %}:</span>
                            <span class="pattern-value">{{ trend.first_value }} â†’ {{ trend.last_value }}</span>
                        </div>
                    </div>
                </div>
                {% empty %}
                <div class="col-12 text-center py-4">
                    <i class="fas fa-chart-line fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">{% trans "No trend data available" %}</h5>
                    <p class="text-muted">{% trans "More readings are needed to analyze trends" %}</p>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Risk Assessment -->
    {% if analytics.risks %}
    <div class="analytics-card">
        <div class="card-body">
            <h5 class="card-title mb-4">
                <i class="fas fa-exclamation-triangle text-warning"></i>
                {% trans "Risk Assessment" %}
            </h5>
            {% for risk in analytics.risks %}
            <div class="risk-card {% if risk.type == 'critical' %}border-danger{% elif risk.type == 'trend' %}warning{% else %}info{% endif %}">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <h6 class="mb-1">{{ risk.category }}</h6>
                        <p class="mb-1">{{ risk.message }}</p>
                        <small class="text-muted">{{ risk.date|date:"M d, Y H:i" }}</small>
                    </div>
                    <span class="badge {% if risk.type == 'critical' %}bg-danger{% elif risk.type == 'trend' %}bg-warning{% else %}bg-info{% endif %}">
                        {{ risk.type|title }}
                    </span>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- Recommendations -->
    {% if analytics.recommendations %}
    <div class="analytics-card">
        <div class="card-body">
            <h5 class="card-title mb-4">
                <i class="fas fa-lightbulb text-success"></i>
                {% trans "Health Recommendations" %}
            </h5>
            {% for recommendation in analytics.recommendations %}
            <div class="recommendation-card">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <h6 class="mb-1">{{ recommendation.category|default:"General" }}</h6>
                        <p class="mb-0">{{ recommendation.message }}</p>
                    </div>
                    <span class="badge bg-success">{{ recommendation.type|title }}</span>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- Pattern Analysis -->
    <div class="analytics-card">
        <div class="card-body">
            <h5 class="card-title mb-4">
                <i class="fas fa-chart-bar"></i>
                {% trans "Pattern Analysis" %}
            </h5>
            <div class="row">
                {% for category, pattern in analytics.patterns.items %}
                <div class="col-md-6 col-lg-4 mb-4">
                    <div class="pattern-analysis">
                        <h6 class="mb-3">{{ category }}</h6>
                        <div class="pattern-item">
                            <span class="pattern-label">{% trans "Total Readings" %}:</span>
                            <span class="pattern-value">{{ pattern.total_readings }}</span>
                        </div>
                        <div class="pattern-item">
                            <span class="pattern-label">{% trans "Average Value" %}:</span>
                            <span class="pattern-value">{{ pattern.avg_value|floatformat:1 }}</span>
                        </div>
                        {% for status in pattern.status_distribution %}
                        <div class="pattern-item">
                            <span class="pattern-label">{{ status.status|title }}:</span>
                            <span class="pattern-value">{{ status.count }}</span>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% empty %}
                <div class="col-12 text-center py-4">
                    <i class="fas fa-chart-bar fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">{% trans "No pattern data available" %}</h5>
                    <p class="text-muted">{% trans "More readings are needed to analyze patterns" %}</p>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Interactive Charts -->
    <div class="row">
        <div class="col-lg-8">
            <div class="analytics-card">
                <div class="card-body">
                    <h5 class="card-title mb-4">
                        <i class="fas fa-chart-line"></i>
                        {% trans "Vital Signs Timeline" %}
                    </h5>
                    <div class="chart-container">
                        <canvas id="vitalTimelineChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-4">
            <div class="analytics-card">
                <div class="card-body">
                    <h5 class="card-title mb-4">
                        <i class="fas fa-chart-pie"></i>
                        {% trans "Status Distribution" %}
                    </h5>
                    <div class="chart-container">
                        <canvas id="statusDistributionChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Chart.js configurations
const chartColors = {
    primary: '#14b8a6',
    secondary: '#0d9488',
    success: '#10b981',
    warning: '#f59e0b',
    danger: '#ef4444',
    info: '#3b82f6',
    light: '#f3f4f6'
};

// Initialize charts when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
    initializeAnalyticsCharts();
    animateMetricNumbers();
});

function initializeAnalyticsCharts() {
    // Vital Timeline Chart
    const timelineCtx = document.getElementById('vitalTimelineChart');
    if (timelineCtx) {
        new Chart(timelineCtx, {
            type: 'line',
            data: {
                labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
                datasets: [{
                    label: 'Blood Pressure',
                    data: [120, 118, 122, 119, 121, 117],
                    borderColor: chartColors.primary,
                    backgroundColor: chartColors.primary + '20',
                    tension: 0.4
                }, {
                    label: 'Heart Rate',
                    data: [72, 75, 70, 73, 71, 74],
                    borderColor: chartColors.success,
                    backgroundColor: chartColors.success + '20',
                    tension: 0.4
                }, {
                    label: 'Temperature',
                    data: [98.6, 98.4, 98.8, 98.5, 98.7, 98.3],
                    borderColor: chartColors.warning,
                    backgroundColor: chartColors.warning + '20',
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    intersect: false,
                    mode: 'index'
                },
                plugins: {
                    legend: {
                        position: 'top',
                        labels: {
                            usePointStyle: true,
                            padding: 20
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        titleColor: 'white',
                        bodyColor: 'white',
                        borderColor: chartColors.primary,
                        borderWidth: 1
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: {
                            color: '#f1f5f9'
                        }
                    },
                    x: {
                        grid: {
                            display: false
                        }
                    }
                }
            }
        });
    }

    // Status Distribution Chart
    const statusCtx = document.getElementById('statusDistributionChart');
    if (statusCtx) {
        new Chart(statusCtx, {
            type: 'doughnut',
            data: {
                labels: ['Normal', 'Abnormal', 'Critical'],
                datasets: [{
                    data: [
                        {{ analytics.summary.normal_percentage }},
                        {{ 100|add:"-"|add:analytics.summary.normal_percentage|add:"-"|add:analytics.risks|length }},
                        {{ analytics.risks|length }}
                    ],
                    backgroundColor: [
                        chartColors.success,
                        chartColors.warning,
                        chartColors.danger
                    ],
                    borderWidth: 2,
                    borderColor: '#fff'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            usePointStyle: true,
                            padding: 20
                        }
                    }
                }
            }
        });
    }
}

function animateMetricNumbers() {
    const metricNumbers = document.querySelectorAll('.metric-number');
    metricNumbers.forEach(metric => {
        const finalValue = parseInt(metric.textContent) || 0;
        let currentValue = 0;
        const increment = finalValue / 30;
        
        const timer = setInterval(() => {
            currentValue += increment;
            if (currentValue >= finalValue) {
                metric.textContent = finalValue;
                clearInterval(timer);
            } else {
                metric.textContent = Math.floor(currentValue);
            }
        }, 30);
    });
}

// Add smooth scrolling for better UX
document.querySelectorAll('a[href^="#"]').forEach(anchor => {
    anchor.addEventListener('click', function (e) {
        e.preventDefault();
        const target = document.querySelector(this.getAttribute('href'));
        if (target) {
            target.scrollIntoView({
                behavior: 'smooth',
                block: 'start'
            });
        }
    });
});
</script>
{% endblock %} 