{% extends 'base.html' %}
{% load static %}
{% load i18n %}

{% block title %}{% trans "Vitals Dashboard" %}{% endblock %}

{% block content %}
<div class="breadcrumb-bar">
    <div class="container-fluid">
        <div class="row align-items-center">
            <div class="col-md-12 col-12">
                <nav aria-label="breadcrumb" class="page-breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="{% url 'core:home' %}">{% trans "Home" %}</a></li>
                        <li class="breadcrumb-item active" aria-current="page">{% trans "Vitals Dashboard" %}</li>
                    </ol>
                </nav>
                <h2 class="breadcrumb-title">{% trans "Vitals Dashboard" %}</h2>
            </div>
        </div>
    </div>
</div>

<div class="content">
    <div class="container-fluid">
        <div class="row">
            <!-- Profile Sidebar -->
            <div class="col-md-5 col-lg-4 col-xl-3 theiaStickySidebar">
                {% include 'includes/patient-sidebar.html' with active='vitals' %}
            </div>
            <!-- /Profile Sidebar -->

            <div class="col-md-7 col-lg-8 col-xl-9">
                <!-- Notifications -->
                {% if notifications %}
                <div class="card">
                    <div class="card-header">
                        <h4 class="card-title">{% trans "Health Alerts" %}</h4>
                    </div>
                    <div class="card-body">
                        {% for notification in notifications %}
                        <div class="alert alert-{{ notification.severity }} alert-dismissible fade show" role="alert">
                            {{ notification.message }}
                            <button type="button" class="btn-close notification-dismiss" data-id="{{ notification.id }}" aria-label="Close"></button>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                <!-- Quick Actions -->
                <div class="card">
                    <div class="card-header">
                        <h4 class="card-title">{% trans "Quick Actions" %}</h4>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <a href="#" class="btn btn-primary btn-block" data-bs-toggle="modal" data-bs-target="#add_vital_modal">
                                    <i class="fas fa-plus-circle"></i> {% trans "Record Vital Sign" %}
                                </a>
                            </div>
                            <div class="col-md-4 mb-3">
                                <a href="{% url 'vitals:vital-history' %}" class="btn btn-info btn-block">
                                    <i class="fas fa-chart-line"></i> {% trans "View History" %}
                                </a>
                            </div>
                            <div class="col-md-4 mb-3">
                                <a href="{% url 'vitals:manage-goals' %}" class="btn btn-success btn-block">
                                    <i class="fas fa-bullseye"></i> {% trans "Manage Goals" %}
                                </a>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Latest Vitals -->
                <div class="card">
                    <div class="card-header">
                        <h4 class="card-title">{% trans "Latest Vital Signs" %}</h4>
                    </div>
                    <div class="card-body">
                        {% if latest_vitals %}
                        <div class="row">
                            {% for category in categories %}
                                {% if category.id in latest_vitals %}
                                    {% with vital=latest_vitals|get_item:category.id %}
                                    <div class="col-md-6 col-lg-4 mb-4">
                                        <div class="card vital-card">
                                            <div class="card-body">
                                                <div class="vital-icon" style="background-color: {{ category.color }}">
                                                    <i class="{{ category.icon }}"></i>
                                                </div>
                                                <h5 class="vital-title">{{ category.name }}</h5>
                                                <div class="vital-value">
                                                    <span class="value">{{ vital.value }}</span>
                                                    {% if vital.secondary_value %}
                                                    <span class="separator">/</span>
                                                    <span class="secondary-value">{{ vital.secondary_value }}</span>
                                                    {% endif %}
                                                    <span class="unit">{{ category.unit }}</span>
                                                </div>
                                                <div class="vital-status status-{{ vital.status }}">
                                                    {{ vital.status_display }}
                                                </div>
                                                <div class="vital-date">
                                                    <small>{% trans "Recorded" %}: {{ vital.recorded_at|date:"M d, Y H:i" }}</small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    {% endwith %}
                                {% else %}
                                    <div class="col-md-6 col-lg-4 mb-4">
                                        <div class="card vital-card vital-card-empty">
                                            <div class="card-body">
                                                <div class="vital-icon" style="background-color: {{ category.color }}">
                                                    <i class="{{ category.icon }}"></i>
                                                </div>
                                                <h5 class="vital-title">{{ category.name }}</h5>
                                                <div class="vital-value">
                                                    <span class="value">--</span>
                                                    <span class="unit">{{ category.unit }}</span>
                                                </div>
                                                <div class="vital-status">
                                                    {% trans "No data recorded" %}
                                                </div>
                                                <div class="vital-action">
                                                    <a href="#" class="btn btn-sm btn-primary record-vital-btn" 
                                                       data-category-id="{{ category.id }}" 
                                                       data-category-name="{{ category.name }}"
                                                       data-bs-toggle="modal" 
                                                       data-bs-target="#add_vital_modal">
                                                        {% trans "Record Now" %}
                                                    </a>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                {% endif %}
                            {% endfor %}
                        </div>
                        {% else %}
                        <div class="alert alert-info">
                            {% trans "You haven't recorded any vital signs yet." %}
                            <a href="#" data-bs-toggle="modal" data-bs-target="#add_vital_modal">{% trans "Record your first vital sign now" %}</a>.
                        </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Active Goals -->
                {% if active_goals %}
                <div class="card">
                    <div class="card-header">
                        <h4 class="card-title">{% trans "Active Health Goals" %}</h4>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover table-center mb-0">
                                <thead>
                                    <tr>
                                        <th>{% trans "Vital Sign" %}</th>
                                        <th>{% trans "Target" %}</th>
                                        <th>{% trans "Current" %}</th>
                                        <th>{% trans "Progress" %}</th>
                                        <th>{% trans "Target Date" %}</th>
                                        <th>{% trans "Actions" %}</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for goal in active_goals %}
                                    <tr>
                                        <td>
                                            <h2 class="table-avatar">
                                                <div class="avatar avatar-sm me-2" style="background-color: {{ goal.category.color }}">
                                                    <i class="{{ goal.category.icon }} text-white"></i>
                                                </div>
                                                {{ goal.category.name }}
                                            </h2>
                                        </td>
                                        <td>{{ goal.target_value }} {{ goal.category.unit }}</td>
                                        <td>
                                            {% if goal.category.id in latest_vitals %}
                                                {% with vital=latest_vitals|get_item:goal.category.id %}
                                                    {{ vital.value }} {{ goal.category.unit }}
                                                {% endwith %}
                                            {% else %}
                                                --
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if goal.category.id in latest_vitals %}
                                                {% with vital=latest_vitals|get_item:goal.category.id %}
                                                    {% if goal.category.name.lower == 'weight' or goal.category.name.lower == 'blood pressure' or goal.category.name.lower == 'cholesterol' %}
                                                        {% if vital.value <= goal.target_value %}
                                                            <div class="progress" style="height: 5px;">
                                                                <div class="progress-bar bg-success" role="progressbar" style="width: 100%"></div>
                                                            </div>
                                                            <small class="text-success">{% trans "Goal reached!" %}</small>
                                                        {% else %}
                                                            {% with progress=vital.value|calculate_progress:goal.target_value %}
                                                            <div class="progress" style="height: 5px;">
                                                                <div class="progress-bar bg-info" role="progressbar" style="width: {{ progress }}%"></div>
                                                            </div>
                                                            <small>{{ progress }}% {% trans "complete" %}</small>
                                                            {% endwith %}
                                                        {% endif %}
                                                    {% else %}
                                                        {% if vital.value >= goal.target_value %}
                                                            <div class="progress" style="height: 5px;">
                                                                <div class="progress-bar bg-success" role="progressbar" style="width: 100%"></div>
                                                            </div>
                                                            <small class="text-success">{% trans "Goal reached!" %}</small>
                                                        {% else %}
                                                            {% with progress=vital.value|calculate_progress:goal.target_value %}
                                                            <div class="progress" style="height: 5px;">
                                                                <div class="progress-bar bg-info" role="progressbar" style="width: {{ progress }}%"></div>
                                                            </div>
                                                            <small>{{ progress }}% {% trans "complete" %}</small>
                                                            {% endwith %}
                                                        {% endif %}
                                                    {% endif %}
                                                {% endwith %}
                                            {% else %}
                                                <div class="progress" style="height: 5px;">
                                                    <div class="progress-bar bg-info" role="progressbar" style="width: 0%"></div>
                                                </div>
                                                <small>0% {% trans "complete" %}</small>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if goal.target_date %}
                                                {{ goal.target_date|date:"M d, Y" }}
                                            {% else %}
                                                --
                                            {% endif %}
                                        </td>
                                        <td>
                                            <div class="btn-group">
                                                <form method="post" action="{% url 'vitals:mark-goal-achieved' goal.id %}" class="d-inline">
                                                    {% csrf_token %}
                                                    <button type="submit" class="btn btn-sm btn-success">
                                                        <i class="fas fa-check"></i>
                                                    </button>
                                                </form>
                                                <form method="post" action="{% url 'vitals:delete-goal' goal.id %}" class="d-inline">
                                                    {% csrf_token %}
                                                    <button type="submit" class="btn btn-sm btn-danger">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                </form>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Add Vital Modal -->
<div class="modal fade" id="add_vital_modal" tabindex="-1" aria-labelledby="addVitalModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addVitalModalLabel">{% trans "Record Vital Sign" %}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="post" action="{% url 'vitals:add-vital' %}">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="form-group">
                        <label for="{{ form.category.id_for_label }}">{% trans "Vital Sign" %}</label>
                        {{ form.category }}
                    </div>
                    <div class="form-group">
                        <label for="{{ form.value.id_for_label }}">{% trans "Value" %}</label>
                        {{ form.value }}
                    </div>
                    <div class="form-group secondary-value-group" style="display: none;">
                        <label for="{{ form.secondary_value.id_for_label }}">{% trans "Secondary Value (e.g. Diastolic)" %}</label>
                        {{ form.secondary_value }}
                        <small class="form-text text-muted">{{ form.secondary_value.help_text }}</small>
                    </div>
                    <div class="form-group">
                        <label for="{{ form.notes.id_for_label }}">{% trans "Notes" %}</label>
                        {{ form.notes }}
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% trans "Cancel" %}</button>
                    <button type="submit" class="btn btn-primary">{% trans "Save" %}</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    $(document).ready(function() {
        // Handle notification dismissal
        $('.notification-dismiss').on('click', function() {
            var notificationId = $(this).data('id');
            $.post("{% url 'vitals:mark-notification-read' 0 %}".replace('0', notificationId), {
                csrfmiddlewaretoken: '{{ csrf_token }}'
            });
        });
        
        // Handle record vital button
        $('.record-vital-btn').on('click', function() {
            var categoryId = $(this).data('category-id');
            var categoryName = $(this).data('category-name');
            
            $('#id_category').val(categoryId);
            $('#addVitalModalLabel').text("{% trans 'Record' %} " + categoryName);
            
            // Show/hide secondary value field based on category
            if (categoryName.toLowerCase() === 'blood pressure') {
                $('.secondary-value-group').show();
            } else {
                $('.secondary-value-group').hide();
            }
        });
        
        // Show/hide secondary value field based on category selection
        $('#id_category').on('change', function() {
            var categoryName = $(this).find('option:selected').text();
            
            if (categoryName.toLowerCase() === 'blood pressure') {
                $('.secondary-value-group').show();
            } else {
                $('.secondary-value-group').hide();
            }
        });
    });
</script>
{% endblock %}