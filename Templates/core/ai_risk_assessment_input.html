{% extends 'core/base.html' %}
{% load static %}

{% block title %}AI Risk Assessment - Healthcare Worker Portal{% endblock %}

{% block extra_css %}
<style>
    .assessment-container {
        background: #f8fafc;
        min-height: 100vh;
        padding: 20px;
    }
    
    .assessment-card {
        background: white;
        border-radius: 12px;
        padding: 24px;
        margin-bottom: 24px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    .assessment-header {
        background: white;
        border-radius: 12px;
        padding: 24px;
        margin-bottom: 24px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    .assessment-module {
        background: white;
        border-radius: 12px;
        padding: 24px;
        margin-bottom: 20px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        transition: transform 0.2s, box-shadow 0.2s;
    }
    
    .assessment-module:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    
    .module-icon {
        width: 48px;
        height: 48px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 16px;
        font-size: 24px;
        color: white;
    }
    
    .module-icon.cardiovascular {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    
    .module-icon.organ-damage {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    }
    
    .module-title {
        font-size: 18px;
        font-weight: 600;
        color: #1f2937;
        margin-bottom: 8px;
    }
    
    .module-description {
        color: #6b7280;
        font-size: 14px;
        margin-bottom: 16px;
        line-height: 1.5;
    }
    
    .module-about {
        background: #f8fafc;
        border-radius: 8px;
        padding: 16px;
        margin-bottom: 16px;
    }
    
    .module-about h6 {
        color: #374151;
        font-weight: 600;
        margin-bottom: 8px;
        display: flex;
        align-items: center;
    }
    
    .module-about h6 i {
        margin-right: 8px;
        color: #06b6d4;
    }
    
    .module-about p {
        color: #6b7280;
        font-size: 13px;
        margin-bottom: 0;
        line-height: 1.4;
    }
    
    .target-organs {
        margin-top: 12px;
    }
    
    .target-organs h6 {
        font-size: 14px;
        font-weight: 600;
        color: #374151;
        margin-bottom: 8px;
    }
    
    .organ-list {
        list-style: none;
        padding: 0;
        margin: 0;
    }
    
    .organ-list li {
        padding: 4px 0;
        font-size: 13px;
        color: #6b7280;
        position: relative;
        padding-left: 16px;
    }
    
    .organ-list li:before {
        content: "â€¢";
        position: absolute;
        left: 0;
        color: #06b6d4;
        font-weight: bold;
    }
    
    .patient-summary {
        background: #f8fafc;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
    }
    
    .patient-summary h5 {
        color: #374151;
        font-weight: 600;
        margin-bottom: 16px;
    }
    
    .patient-data {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 16px;
    }
    
    .data-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 0;
        border-bottom: 1px solid #e5e7eb;
    }
    
    .data-item:last-child {
        border-bottom: none;
    }
    
    .data-label {
        font-weight: 500;
        color: #374151;
        font-size: 14px;
    }
    
    .data-value {
        color: #6b7280;
        font-size: 14px;
        font-weight: 600;
    }
    
    .run-analysis-btn {
        background: #06b6d4;
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 8px;
        font-weight: 600;
        font-size: 14px;
        display: flex;
        align-items: center;
        justify-content: center;
        width: 100%;
        transition: all 0.2s;
        text-decoration: none;
    }
    
    .run-analysis-btn:hover {
        background: #0891b2;
        color: white;
        text-decoration: none;
        transform: translateY(-1px);
    }
    
    .run-analysis-btn:disabled {
        background: #9ca3af;
        cursor: not-allowed;
        transform: none;
    }
    
    .run-analysis-btn i {
        margin-right: 8px;
    }
    
    .loading-spinner {
        display: none;
        width: 20px;
        height: 20px;
        border: 2px solid #ffffff;
        border-top: 2px solid transparent;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-right: 8px;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    .status-indicator {
        display: inline-flex;
        align-items: center;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 600;
        margin-top: 8px;
    }
    
    .status-indicator.ready {
        background: #dcfce7;
        color: #16a34a;
    }
    
    .status-indicator.not-ready {
        background: #fef2f2;
        color: #dc2626;
    }
    
    .status-indicator i {
        margin-right: 4px;
    }
    
    @media (max-width: 768px) {
        .assessment-container {
            padding: 12px;
        }
        
        .assessment-card, .assessment-header, .assessment-module {
            padding: 16px;
        }
        
        .patient-data {
            grid-template-columns: 1fr;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="assessment-container">
    <!-- Header Section -->
    <div class="assessment-header">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h1 class="h3 mb-1">AI Risk Assessment</h1>
                <p class="text-muted mb-0">National Heart Hospital - Hypertension Monitoring Module</p>
            </div>
            <div class="d-flex gap-2">
                <button class="btn btn-outline-secondary btn-sm">
                    <i class="fas fa-globe"></i>
                </button>
                <button class="btn btn-outline-secondary btn-sm">
                    <i class="fas fa-bell"></i>
                </button>
                <button class="btn btn-outline-secondary btn-sm">
                    <i class="fas fa-sun"></i>
                </button>
                <div class="dropdown">
                    <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown">
                        <i class="fas fa-user"></i> {{ user.get_full_name }}
                    </button>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="{% url 'profile-settings' %}">Profile</a></li>
                        <li><a class="dropdown-item" href="{% url 'logout' %}">Logout</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Assessment Modules -->
        <div class="col-lg-8">
            <!-- Cardiovascular Disease Risk Assessment -->
            <div class="assessment-module">
                <div class="d-flex align-items-start">
                    <div class="module-icon cardiovascular">
                        <i class="fas fa-heart"></i>
                    </div>
                    <div class="flex-grow-1 ms-3">
                        <h3 class="module-title">{{ assessment_data.cardiovascular_assessment.title }}</h3>
                        <p class="module-description">{{ assessment_data.cardiovascular_assessment.description }}</p>
                        
                        <div class="module-about">
                            <h6>
                                <i class="fas fa-info-circle"></i>
                                About this analysis
                            </h6>
                            <p>{{ assessment_data.cardiovascular_assessment.about }}</p>
                        </div>
                        
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="status-indicator {% if assessment_data.cardiovascular_assessment.ready_to_run %}ready{% else %}not-ready{% endif %}">
                                <i class="fas fa-{% if assessment_data.cardiovascular_assessment.ready_to_run %}check-circle{% else %}exclamation-circle{% endif %}"></i>
                                {% if assessment_data.cardiovascular_assessment.ready_to_run %}Ready to run{% else %}Data incomplete{% endif %}
                            </div>
                            <button class="run-analysis-btn" 
                                    onclick="runAnalysis('cardiovascular')" 
                                    {% if not assessment_data.cardiovascular_assessment.ready_to_run %}disabled{% endif %}
                                    id="cvd-analysis-btn">
                                <div class="loading-spinner" id="cvd-spinner"></div>
                                <i class="fas fa-play" id="cvd-icon"></i>
                                <span id="cvd-text">Run AI Analysis</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- End Organ Damage Risk Assessment -->
            <div class="assessment-module">
                <div class="d-flex align-items-start">
                    <div class="module-icon organ-damage">
                        <i class="fas fa-user-md"></i>
                    </div>
                    <div class="flex-grow-1 ms-3">
                        <h3 class="module-title">{{ assessment_data.end_organ_assessment.title }}</h3>
                        <p class="module-description">{{ assessment_data.end_organ_assessment.description }}</p>
                        
                        <div class="module-about">
                            <h6>
                                <i class="fas fa-info-circle"></i>
                                About this analysis
                            </h6>
                            <p>{{ assessment_data.end_organ_assessment.about }}</p>
                        </div>
                        
                        {% if assessment_data.end_organ_assessment.target_organs %}
                        <div class="target-organs">
                            <h6>Target Organ Systems</h6>
                            <ul class="organ-list">
                                {% for organ in assessment_data.end_organ_assessment.target_organs %}
                                <li>{{ organ }}</li>
                                {% endfor %}
                            </ul>
                        </div>
                        {% endif %}
                        
                        <div class="d-flex justify-content-between align-items-center mt-3">
                            <div class="status-indicator {% if assessment_data.end_organ_assessment.ready_to_run %}ready{% else %}not-ready{% endif %}">
                                <i class="fas fa-{% if assessment_data.end_organ_assessment.ready_to_run %}check-circle{% else %}exclamation-circle{% endif %}"></i>
                                {% if assessment_data.end_organ_assessment.ready_to_run %}Ready to run{% else %}Data incomplete{% endif %}
                            </div>
                            <button class="run-analysis-btn" 
                                    onclick="runAnalysis('end_organ')" 
                                    {% if not assessment_data.end_organ_assessment.ready_to_run %}disabled{% endif %}
                                    id="organ-analysis-btn">
                                <div class="loading-spinner" id="organ-spinner"></div>
                                <i class="fas fa-play" id="organ-icon"></i>
                                <span id="organ-text">Run AI Analysis</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Patient Data Summary -->
        <div class="col-lg-4">
            <div class="assessment-card">
                <div class="patient-summary">
                    <h5>Patient Data Summary</h5>
                    
                    <div class="mb-3">
                        <div class="data-item">
                            <span class="data-label">Name:</span>
                            <span class="data-value">{{ assessment_data.patient.name }}</span>
                        </div>
                        <div class="data-item">
                            <span class="data-label">Age:</span>
                            <span class="data-value">{{ assessment_data.patient.age }}</span>
                        </div>
                    </div>
                    
                    <div class="patient-data">
                        <div>
                            <div class="data-item">
                                <span class="data-label">Blood Pressure:</span>
                                <span class="data-value">{{ assessment_data.patient.blood_pressure }}</span>
                            </div>
                            <div class="data-item">
                                <span class="data-label">Heart Rate:</span>
                                <span class="data-value">{{ assessment_data.patient.heart_rate }}</span>
                            </div>
                        </div>
                        <div>
                            <div class="data-item">
                                <span class="data-label">Cholesterol:</span>
                                <span class="data-value">{{ assessment_data.patient.cholesterol }}</span>
                            </div>
                            <div class="data-item">
                                <span class="data-label">Smoking:</span>
                                <span class="data-value">{{ assessment_data.patient.smoking_status }}</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Quick Actions -->
                <div class="mt-3">
                    <h6 class="mb-3">Quick Actions</h6>
                    <div class="d-grid gap-2">
                        <a href="{% url 'patient-detail' patient.id %}" class="btn btn-outline-primary btn-sm">
                            <i class="fas fa-user"></i> View Patient Profile
                        </a>
                        <a href="{% url 'vitals-list' %}?patient={{ patient.id }}" class="btn btn-outline-primary btn-sm">
                            <i class="fas fa-chart-line"></i> View Vitals History
                        </a>
                        <a href="{% url 'lab-test-list' %}?patient={{ patient.id }}" class="btn btn-outline-primary btn-sm">
                            <i class="fas fa-flask"></i> View Lab Results
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Results Modal -->
<div class="modal fade" id="resultsModal" tabindex="-1" aria-labelledby="resultsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="resultsModalLabel">AI Analysis Results</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="resultsContent">
                <!-- Results will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="viewFullReport()">View Full Report</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let currentAnalysisType = null;
    
    function runAnalysis(analysisType) {
        currentAnalysisType = analysisType;
        const btnId = analysisType === 'cardiovascular' ? 'cvd' : 'organ';
        const btn = document.getElementById(`${btnId}-analysis-btn`);
        const spinner = document.getElementById(`${btnId}-spinner`);
        const icon = document.getElementById(`${btnId}-icon`);
        const text = document.getElementById(`${btnId}-text`);
        
        // Show loading state
        btn.disabled = true;
        spinner.style.display = 'block';
        icon.style.display = 'none';
        text.textContent = 'Running Analysis...';
        
        // Make AJAX request
        fetch(`{% url 'run-ai-analysis' patient.id %}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({
                'analysis_type': analysisType
            })
        })
        .then(response => response.json())
        .then(data => {
            // Hide loading state
            btn.disabled = false;
            spinner.style.display = 'none';
            icon.style.display = 'block';
            text.textContent = 'Run AI Analysis';
            
            if (data.success) {
                // Show results in modal or redirect
                if (analysisType === 'cardiovascular') {
                    window.location.href = `{% url 'ai-risk-assessment-results' patient.id %}?type=cardiovascular`;
                } else {
                    window.location.href = `{% url 'ai-risk-assessment-results' patient.id %}?type=end_organ`;
                }
            } else {
                alert('Error running analysis: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            // Hide loading state
            btn.disabled = false;
            spinner.style.display = 'none';
            icon.style.display = 'block';
            text.textContent = 'Run AI Analysis';
            alert('Error running analysis. Please try again.');
        });
    }
    
    function viewFullReport() {
        if (currentAnalysisType) {
            window.open(`{% url 'ai-risk-assessment-results' patient.id %}?type=${currentAnalysisType}&format=full`, '_blank');
        }
    }
</script>
{% endblock %}