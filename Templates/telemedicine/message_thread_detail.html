{% extends 'core/base.html' %}
{% load static %}
{% load i18n %}

{% block title %}{% translate "Conversation" %} - {{ other_user.get_full_name }}{% endblock %}

{% block extra_css %}
<style>
    .chat-container {
        height: calc(100vh - 200px);
        min-height: 600px;
        display: flex;
        flex-direction: column;
    }
    
    .chat-header {
        padding: 20px;
        border-bottom: 1px solid #e5e5e5;
        background-color: #f8f9fa;
    }
    
    .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
        background-color: #fafafa;
    }
    
    .message {
        margin-bottom: 20px;
        display: flex;
    }
    
    .message.own {
        justify-content: flex-end;
    }
    
    .message-bubble {
        max-width: 70%;
        padding: 12px 18px;
        border-radius: 18px;
        word-wrap: break-word;
    }
    
    .message.own .message-bubble {
        background-color: #2196f3;
        color: white;
    }
    
    .message:not(.own) .message-bubble {
        background-color: white;
        border: 1px solid #e5e5e5;
    }
    
    .message-time {
        font-size: 0.8em;
        opacity: 0.7;
        margin-top: 5px;
    }
    
    .message.urgent .message-bubble {
        border-left: 4px solid #f44336;
    }
    
    .chat-input {
        padding: 20px;
        border-top: 1px solid #e5e5e5;
        background-color: white;
    }
    
    .user-avatar {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        background-color: #2196f3;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
        font-size: 1.2em;
    }
    
    .call-buttons {
        display: flex;
        gap: 10px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card chat-container">
                <!-- Chat Header -->
                <div class="chat-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center">
                            <div class="user-avatar me-3">
                                {{ other_user.first_name|first }}{{ other_user.last_name|first }}
                            </div>
                            <div>
                                <h4 class="mb-0">
                                    {% if other_user.is_doctor %}
                                        Dr. {{ other_user.get_full_name }}
                                    {% else %}
                                        {{ other_user.get_full_name }}
                                    {% endif %}
                                </h4>
                                {% if other_user.is_doctor and other_user.specialization %}
                                <small class="text-muted">{{ other_user.specialization }}</small>
                                {% endif %}
                            </div>
                        </div>
                        
                        {% if can_start_call %}
                        <div class="call-buttons">
                            <button class="btn btn-outline-primary" id="audio-call-btn">
                                <i class="fas fa-phone"></i> {% translate "Audio Call" %}
                            </button>
                            <button class="btn btn-primary" id="video-call-btn">
                                <i class="fas fa-video"></i> {% translate "Video Call" %}
                            </button>
                        </div>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Messages -->
                <div class="chat-messages" id="chat-messages">
                    {% for message in messages %}
                    <div class="message {% if message.sender == request.user %}own{% endif %}{% if message.is_urgent %} urgent{% endif %}">
                        <div class="message-bubble">
                            {% if message.message_type == 'video_call_request' %}
                                <i class="fas fa-video me-2"></i>
                                {% translate "Video call request" %}
                                {% if message.call_status %}
                                    <small class="d-block mt-1">
                                        {% translate "Status:" %} {{ message.get_call_status_display }}
                                    </small>
                                {% endif %}
                            {% elif message.message_type == 'audio_call_request' %}
                                <i class="fas fa-phone me-2"></i>
                                {% translate "Audio call request" %}
                                {% if message.call_status %}
                                    <small class="d-block mt-1">
                                        {% translate "Status:" %} {{ message.get_call_status_display }}
                                    </small>
                                {% endif %}
                            {% else %}
                                {{ message.content }}
                            {% endif %}
                            
                            <div class="message-time">
                                {{ message.created_at|date:"H:i" }}
                                {% if message.is_read and message.sender == request.user %}
                                    <i class="fas fa-check-double text-primary ms-1"></i>
                                {% elif message.sender == request.user %}
                                    <i class="fas fa-check ms-1"></i>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% empty %}
                    <div class="text-center text-muted py-5">
                        <i class="fas fa-comments fa-3x mb-3"></i>
                        <p>{% translate "No messages yet" %}</p>
                        <p class="small">{% translate "Start the conversation by sending a message" %}</p>
                    </div>
                    {% endfor %}
                </div>
                
                <!-- Message Input -->
                <div class="chat-input">
                    <form id="message-form">
                        {% csrf_token %}
                        <div class="input-group">
                            <input type="text" class="form-control" id="message-input" 
                                   placeholder="{% translate 'Type your message...' %}" required>
                            <button class="btn btn-primary" type="submit">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Back Button -->
<div class="position-fixed" style="top: 100px; left: 20px;">
    <a href="{% if request.user.is_doctor %}{% url 'telemedicine:doctor-messages' %}{% else %}{% url 'telemedicine:patient-messages' %}{% endif %}" 
       class="btn btn-light btn-sm">
        <i class="fas fa-arrow-left"></i> {% translate "Back" %}
    </a>
</div>
{% endblock %}

{% block extra_js %}
<script>
// WebSocket connection for real-time messaging
let messageSocket = null;
const threadId = {{ thread.id }};
const otherUserId = {{ other_user.id }};
const currentUserId = {{ request.user.id }};

// Initialize WebSocket connection
function initializeWebSocket() {
    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
    const wsUrl = `${protocol}//${window.location.host}/ws/messages/`;
    
    messageSocket = new WebSocket(wsUrl);
    
    messageSocket.onopen = function(e) {
        console.log('WebSocket connection established');
    };
    
    messageSocket.onmessage = function(e) {
        const data = JSON.parse(e.data);
        handleWebSocketMessage(data);
    };
    
    messageSocket.onclose = function(e) {
        console.log('WebSocket connection closed');
        // Attempt to reconnect after 3 seconds
        setTimeout(initializeWebSocket, 3000);
    };
    
    messageSocket.onerror = function(e) {
        console.error('WebSocket error:', e);
    };
}

// Handle WebSocket messages
function handleWebSocketMessage(data) {
    switch(data.type) {
        case 'new_message':
            if (data.sender_id == otherUserId) {
                addMessageToChat(data.message, false);
                scrollToBottom();
            }
            break;
        case 'message_sent':
            addMessageToChat(data.message, true);
            scrollToBottom();
            break;
    }
}

// Send message
function sendMessage(content) {
    if (!content.trim()) return;
    
    const messageData = {
        type: 'send_message',
        recipient_id: otherUserId,
        content: content,
        message_type: 'text',
        is_urgent: false
    };
    
    messageSocket.send(JSON.stringify(messageData));
}

// Add message to chat display
function addMessageToChat(message, isOwn) {
    const messagesContainer = document.getElementById('chat-messages');
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${isOwn ? 'own' : ''}${message.is_urgent ? ' urgent' : ''}`;
    
    const bubbleDiv = document.createElement('div');
    bubbleDiv.className = 'message-bubble';
    bubbleDiv.textContent = message.content;
    
    const timeDiv = document.createElement('div');
    timeDiv.className = 'message-time';
    timeDiv.textContent = new Date(message.created_at).toLocaleTimeString();
    
    messageDiv.appendChild(bubbleDiv);
    messageDiv.appendChild(timeDiv);
    messagesContainer.appendChild(messageDiv);
}

// Scroll to bottom of chat
function scrollToBottom() {
    const messagesContainer = document.getElementById('chat-messages');
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

// Start call
function startCall(callType) {
    const callData = {
        type: `start_${callType}_call`,
        recipient_id: otherUserId
    };
    
    messageSocket.send(JSON.stringify(callData));
}

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    initializeWebSocket();
    
    // Message form submission
    document.getElementById('message-form').addEventListener('submit', function(e) {
        e.preventDefault();
        const input = document.getElementById('message-input');
        const content = input.value.trim();
        
        if (content) {
            sendMessage(content);
            input.value = '';
        }
    });
    
    // Call buttons
    const audioCallBtn = document.getElementById('audio-call-btn');
    const videoCallBtn = document.getElementById('video-call-btn');
    
    if (audioCallBtn) {
        audioCallBtn.addEventListener('click', () => startCall('audio'));
    }
    
    if (videoCallBtn) {
        videoCallBtn.addEventListener('click', () => startCall('video'));
    }
    
    // Auto-scroll to bottom on page load
    scrollToBottom();
});
</script>
{% endblock %}