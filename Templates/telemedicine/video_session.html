{% extends 'base.html' %}
{% load static %}

{% block title %}Video Session - {{ appointment.patient.get_full_name }} & {{ appointment.doctor.get_full_name }}{% endblock %}

{% block extra_css %}
<style>
    .video-container {
        position: relative;
        background: #000;
        border-radius: 8px;
        overflow: hidden;
    }
    
    .local-video {
        position: absolute;
        top: 10px;
        right: 10px;
        width: 200px;
        height: 150px;
        border: 2px solid #fff;
        border-radius: 8px;
        z-index: 10;
    }
    
    .remote-video {
        width: 100%;
        height: 400px;
        object-fit: cover;
    }
    
    .video-controls {
        position: absolute;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        gap: 10px;
        z-index: 20;
    }
    
    .control-btn {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        border: none;
        color: white;
        font-size: 18px;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .control-btn.video-btn {
        background: #28a745;
    }
    
    .control-btn.video-btn.off {
        background: #dc3545;
    }
    
    .control-btn.audio-btn {
        background: #007bff;
    }
    
    .control-btn.audio-btn.off {
        background: #dc3545;
    }
    
    .control-btn.end-btn {
        background: #dc3545;
    }
    
    .control-btn:hover {
        transform: scale(1.1);
    }
    
    .session-info {
        background: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 10px;
        border-radius: 8px;
        margin-bottom: 20px;
    }
    
    .connection-status {
        position: absolute;
        top: 10px;
        left: 10px;
        padding: 5px 10px;
        border-radius: 15px;
        font-size: 12px;
        font-weight: bold;
        z-index: 15;
    }
    
    .connection-status.connected {
        background: #28a745;
        color: white;
    }
    
    .connection-status.connecting {
        background: #ffc107;
        color: black;
    }
    
    .connection-status.disconnected {
        background: #dc3545;
        color: white;
    }
    
    .chat-panel {
        height: 400px;
        border: 1px solid #ddd;
        border-radius: 8px;
        display: flex;
        flex-direction: column;
    }
    
    .chat-messages {
        flex: 1;
        padding: 15px;
        overflow-y: auto;
        background: #f8f9fa;
    }
    
    .chat-input-area {
        padding: 15px;
        border-top: 1px solid #ddd;
        background: white;
    }
    
    .message {
        margin-bottom: 10px;
        padding: 8px 12px;
        border-radius: 15px;
        max-width: 80%;
    }
    
    .message.sent {
        background: #007bff;
        color: white;
        margin-left: auto;
        text-align: right;
    }
    
    .message.received {
        background: #e9ecef;
        color: #333;
    }
    
    .message-time {
        font-size: 11px;
        opacity: 0.7;
        margin-top: 3px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <div class="col-12">
            <div class="session-info">
                <h4><i class="fas fa-video"></i> Video Session</h4>
                <p class="mb-1">
                    <strong>Patient:</strong> {{ appointment.patient.get_full_name }} | 
                    <strong>Doctor:</strong> {{ appointment.doctor.get_full_name }}
                </p>
                <p class="mb-0">
                    <strong>Appointment:</strong> {{ appointment.date|date:"M d, Y" }} at {{ appointment.time|time:"g:i A" }}
                </p>
            </div>
        </div>
    </div>
    
    <div class="row">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-body p-0">
                    <div class="video-container">
                        <div class="connection-status connecting" id="connectionStatus">
                            Connecting...
                        </div>
                        
                        <!-- Remote video (other participant) -->
                        <video id="remoteVideo" class="remote-video" autoplay playsinline></video>
                        
                        <!-- Local video (your camera) -->
                        <video id="localVideo" class="local-video" autoplay playsinline muted></video>
                        
                        <!-- Video controls -->
                        <div class="video-controls">
                            <button class="control-btn audio-btn" id="audioBtn" title="Toggle Audio">
                                <i class="fas fa-microphone"></i>
                            </button>
                            <button class="control-btn video-btn" id="videoBtn" title="Toggle Video">
                                <i class="fas fa-video"></i>
                            </button>
                            <button class="control-btn end-btn" id="endBtn" title="End Session">
                                <i class="fas fa-phone-slash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Session Actions -->
            <div class="card mt-3">
                <div class="card-body">
                    <h6>Session Actions</h6>
                    <div class="btn-group" role="group">
                        <button class="btn btn-outline-primary btn-sm" id="shareScreenBtn">
                            <i class="fas fa-desktop"></i> Share Screen
                        </button>
                        <button class="btn btn-outline-info btn-sm" id="recordBtn">
                            <i class="fas fa-record-vinyl"></i> Record Session
                        </button>
                        <button class="btn btn-outline-secondary btn-sm" id="settingsBtn">
                            <i class="fas fa-cog"></i> Settings
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-lg-4">
            <!-- Chat Panel -->
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0"><i class="fas fa-comments"></i> Session Chat</h6>
                </div>
                <div class="card-body p-0">
                    <div class="chat-panel">
                        <div class="chat-messages" id="chatMessages">
                            <div class="message received">
                                <div>Session started. You can now communicate via video and chat.</div>
                                <div class="message-time">{{ session.start_time|time:"g:i A" }}</div>
                            </div>
                        </div>
                        <div class="chat-input-area">
                            <div class="input-group">
                                <input type="text" class="form-control" id="chatInput" placeholder="Type a message...">
                                <button class="btn btn-primary" id="sendChatBtn">
                                    <i class="fas fa-paper-plane"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Session Info -->
            <div class="card mt-3">
                <div class="card-header">
                    <h6 class="mb-0"><i class="fas fa-info-circle"></i> Session Information</h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-6">
                            <small class="text-muted">Session ID:</small>
                            <div class="fw-bold">{{ session.id }}</div>
                        </div>
                        <div class="col-6">
                            <small class="text-muted">Started:</small>
                            <div class="fw-bold">{{ session.start_time|time:"g:i A" }}</div>
                        </div>
                    </div>
                    <div class="row mt-2">
                        <div class="col-6">
                            <small class="text-muted">Duration:</small>
                            <div class="fw-bold" id="sessionDuration">00:00</div>
                        </div>
                        <div class="col-6">
                            <small class="text-muted">Quality:</small>
                            <div class="fw-bold text-success">HD</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Quick Actions -->
            <div class="card mt-3">
                <div class="card-header">
                    <h6 class="mb-0"><i class="fas fa-bolt"></i> Quick Actions</h6>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <button class="btn btn-outline-success btn-sm" onclick="addPrescription()">
                            <i class="fas fa-prescription-bottle"></i> Add Prescription
                        </button>
                        <button class="btn btn-outline-info btn-sm" onclick="addNote()">
                            <i class="fas fa-sticky-note"></i> Add Note
                        </button>
                        <button class="btn btn-outline-warning btn-sm" onclick="uploadDocument()">
                            <i class="fas fa-upload"></i> Upload Document
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- End Session Modal -->
<div class="modal fade" id="endSessionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">End Video Session</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to end this video session?</p>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="saveRecording">
                    <label class="form-check-label" for="saveRecording">
                        Save session recording (if available)
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" onclick="confirmEndSession()">End Session</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// WebRTC Video session management
let localStream = null;
let remoteStream = null;
let peerConnection = null;
let isAudioEnabled = true;
let isVideoEnabled = true;
let sessionStartTime = new Date('{{ session.start_time|date:"c" }}');
let socket = null;

// WebRTC configuration
const rtcConfig = {
    iceServers: [
        { urls: 'stun:stun.l.google.com:19302' },
        { urls: 'stun:stun1.l.google.com:19302' }
    ]
};

// Initialize video session
document.addEventListener('DOMContentLoaded', function() {
    initializeVideoSession();
    startSessionTimer();
    setupEventListeners();
});

async function initializeVideoSession() {
    try {
        document.getElementById('connectionStatus').textContent = 'Initializing camera...';
        
        // Get user media (camera and microphone)
        localStream = await navigator.mediaDevices.getUserMedia({
            video: { width: 1280, height: 720 },
            audio: true
        });
        
        // Display local video
        const localVideo = document.getElementById('localVideo');
        localVideo.srcObject = localStream;
        
        // Initialize WebRTC peer connection
        peerConnection = new RTCPeerConnection(rtcConfig);
        
        // Add local stream to peer connection
        localStream.getTracks().forEach(track => {
            peerConnection.addTrack(track, localStream);
        });
        
        // Handle remote stream
        peerConnection.ontrack = (event) => {
            const remoteVideo = document.getElementById('remoteVideo');
            remoteVideo.srcObject = event.streams[0];
            remoteStream = event.streams[0];
        };
        
        // Handle ICE candidates
        peerConnection.onicecandidate = (event) => {
            if (event.candidate) {
                // Send ICE candidate to remote peer via signaling server
                sendSignal('ice-candidate', event.candidate);
            }
        };
        
        // Update connection status
        document.getElementById('connectionStatus').textContent = 'Ready for connection';
        document.getElementById('connectionStatus').className = 'connection-status connected';
        
        // Add system message to chat
        addChatMessage('system', 'Camera and microphone initialized. Ready for video call.', new Date());
        
        // For demo purposes, simulate a connection after 3 seconds
        setTimeout(() => {
            simulateRemoteConnection();
        }, 3000);
        
    } catch (error) {
        console.error('Error initializing video session:', error);
        document.getElementById('connectionStatus').textContent = 'Camera access denied';
        document.getElementById('connectionStatus').className = 'connection-status disconnected';
        addChatMessage('system', 'Failed to access camera/microphone. Please check permissions.', new Date());
    }
}

function simulateRemoteConnection() {
    // For demo purposes, create a fake remote stream
    const canvas = document.createElement('canvas');
    canvas.width = 640;
    canvas.height = 480;
    const ctx = canvas.getContext('2d');
    
    // Draw a simple animation
    let frame = 0;
    function drawFrame() {
        ctx.fillStyle = '#2c3e50';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        
        ctx.fillStyle = '#3498db';
        ctx.font = '24px Arial';
        ctx.textAlign = 'center';
        ctx.fillText('Remote Participant', canvas.width/2, canvas.height/2 - 20);
        ctx.fillText(`Demo Video Call`, canvas.width/2, canvas.height/2 + 20);
        
        // Animated circle
        ctx.beginPath();
        ctx.arc(canvas.width/2, canvas.height/2 + 60, 20 + Math.sin(frame * 0.1) * 5, 0, 2 * Math.PI);
        ctx.fillStyle = '#e74c3c';
        ctx.fill();
        
        frame++;
        requestAnimationFrame(drawFrame);
    }
    drawFrame();
    
    const fakeStream = canvas.captureStream(30);
    const remoteVideo = document.getElementById('remoteVideo');
    remoteVideo.srcObject = fakeStream;
    
    addChatMessage('system', 'Connected to remote participant (demo mode)', new Date());
}

// WebRTC signaling functions
function sendSignal(type, data) {
    // Send signaling data to the server
    fetch(`/telemedicine/webrtc-signal/{{ session.id }}/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({
            type: type,
            data: data,
            session_id: '{{ session.id }}'
        })
    }).catch(error => {
        console.error('Signaling error:', error);
    });
}

// Create offer for WebRTC connection
async function createOffer() {
    try {
        const offer = await peerConnection.createOffer();
        await peerConnection.setLocalDescription(offer);
        sendSignal('offer', offer);
    } catch (error) {
        console.error('Error creating offer:', error);
    }
}

// Handle incoming offer
async function handleOffer(offer) {
    try {
        await peerConnection.setRemoteDescription(offer);
        const answer = await peerConnection.createAnswer();
        await peerConnection.setLocalDescription(answer);
        sendSignal('answer', answer);
    } catch (error) {
        console.error('Error handling offer:', error);
    }
}

// Handle incoming answer
async function handleAnswer(answer) {
    try {
        await peerConnection.setRemoteDescription(answer);
    } catch (error) {
        console.error('Error handling answer:', error);
    }
}

// Handle incoming ICE candidate
async function handleIceCandidate(candidate) {
    try {
        await peerConnection.addIceCandidate(candidate);
    } catch (error) {
        console.error('Error handling ICE candidate:', error);
    }
}

function setupEventListeners() {
    // Audio toggle
    document.getElementById('audioBtn').addEventListener('click', toggleAudio);
    
    // Video toggle
    document.getElementById('videoBtn').addEventListener('click', toggleVideo);
    
    // End session
    document.getElementById('endBtn').addEventListener('click', showEndSessionModal);
    
    // Chat functionality
    document.getElementById('sendChatBtn').addEventListener('click', sendChatMessage);
    document.getElementById('chatInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            sendChatMessage();
        }
    });
    
    // Additional controls
    document.getElementById('shareScreenBtn').addEventListener('click', shareScreen);
    document.getElementById('recordBtn').addEventListener('click', toggleRecording);
    document.getElementById('settingsBtn').addEventListener('click', showSettings);
}

function toggleAudio() {
    if (localStream) {
        const audioTracks = localStream.getAudioTracks();
        audioTracks.forEach(track => {
            track.enabled = !track.enabled;
        });
        isAudioEnabled = !isAudioEnabled;
    }
    
    const btn = document.getElementById('audioBtn');
    const icon = btn.querySelector('i');
    
    if (isAudioEnabled) {
        btn.classList.remove('off');
        icon.className = 'fas fa-microphone';
        btn.title = 'Mute Audio';
        addChatMessage('system', 'Audio enabled', new Date());
    } else {
        btn.classList.add('off');
        icon.className = 'fas fa-microphone-slash';
        btn.title = 'Unmute Audio';
        addChatMessage('system', 'Audio muted', new Date());
    }
}

function toggleVideo() {
    if (localStream) {
        const videoTracks = localStream.getVideoTracks();
        videoTracks.forEach(track => {
            track.enabled = !track.enabled;
        });
        isVideoEnabled = !isVideoEnabled;
    }
    
    const btn = document.getElementById('videoBtn');
    const icon = btn.querySelector('i');
    const localVideo = document.getElementById('localVideo');
    
    if (isVideoEnabled) {
        btn.classList.remove('off');
        icon.className = 'fas fa-video';
        btn.title = 'Turn Off Video';
        addChatMessage('system', 'Video enabled', new Date());
    } else {
        btn.classList.add('off');
        icon.className = 'fas fa-video-slash';
        btn.title = 'Turn On Video';
        addChatMessage('system', 'Video disabled', new Date());
    }
}

function showEndSessionModal() {
    const modal = new bootstrap.Modal(document.getElementById('endSessionModal'));
    modal.show();
}

function confirmEndSession() {
    // End the session
    fetch(`/telemedicine/video-session/{{ session.id }}/end/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            'Content-Type': 'application/json',
        },
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            addChatMessage('system', 'Session ended', new Date());
            setTimeout(() => {
                window.location.href = '{% url "telemedicine:appointment-detail" appointment.id %}';
            }, 2000);
        }
    })
    .catch(error => {
        console.error('Error ending session:', error);
        alert('Error ending session. Please try again.');
    });
}

function sendChatMessage() {
    const input = document.getElementById('chatInput');
    const message = input.value.trim();
    
    if (message) {
        addChatMessage('sent', message, new Date());
        input.value = '';
        
        // Simulate response (in real implementation, this would be via WebSocket)
        setTimeout(() => {
            const responses = [
                "I understand.",
                "Thank you for the information.",
                "Let me check that for you.",
                "That sounds good.",
                "I'll make a note of that."
            ];
            const randomResponse = responses[Math.floor(Math.random() * responses.length)];
            addChatMessage('received', randomResponse, new Date());
        }, 1000 + Math.random() * 2000);
    }
}

function addChatMessage(type, message, timestamp) {
    const chatMessages = document.getElementById('chatMessages');
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${type}`;
    
    const timeStr = timestamp.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
    
    messageDiv.innerHTML = `
        <div>${message}</div>
        <div class="message-time">${timeStr}</div>
    `;
    
    chatMessages.appendChild(messageDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

function startSessionTimer() {
    setInterval(() => {
        const now = new Date();
        const diff = now - sessionStartTime;
        const minutes = Math.floor(diff / 60000);
        const seconds = Math.floor((diff % 60000) / 1000);
        
        document.getElementById('sessionDuration').textContent = 
            `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }, 1000);
}

function shareScreen() {
    alert('Screen sharing functionality would be implemented here using WebRTC getDisplayMedia API.');
}

function toggleRecording() {
    const btn = document.getElementById('recordBtn');
    const icon = btn.querySelector('i');
    
    if (btn.classList.contains('recording')) {
        btn.classList.remove('recording');
        btn.classList.remove('btn-danger');
        btn.classList.add('btn-outline-info');
        icon.className = 'fas fa-record-vinyl';
        btn.innerHTML = '<i class="fas fa-record-vinyl"></i> Record Session';
        addChatMessage('system', 'Recording stopped', new Date());
    } else {
        btn.classList.add('recording');
        btn.classList.remove('btn-outline-info');
        btn.classList.add('btn-danger');
        icon.className = 'fas fa-stop';
        btn.innerHTML = '<i class="fas fa-stop"></i> Stop Recording';
        addChatMessage('system', 'Recording started', new Date());
    }
}

function showSettings() {
    alert('Video/Audio settings panel would be implemented here.');
}

// Quick action functions
function addPrescription() {
    window.open('{% url "telemedicine:create-prescription" appointment.id %}', '_blank');
}

function addNote() {
    window.open('{% url "telemedicine:create-note" appointment.id %}', '_blank');
}

function uploadDocument() {
    window.open('{% url "telemedicine:upload-document" appointment.id %}', '_blank');
}
</script>
{% endblock %}