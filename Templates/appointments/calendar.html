{% extends 'core/base.html' %}
{% load static %}

{% block title %}Appointment Calendar - Laso Healthcare{% endblock %}

{% block extra_css %}
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.10.1/main.min.css" rel="stylesheet">
<style>
    .fc-event {
        cursor: pointer;
    }
    .fc-toolbar-title {
        font-size: 1.5rem !important;
    }
    .calendar-container {
        background-color: #fff;
        border-radius: 0.625rem;
        box-shadow: 0px 0px 30px 0px rgba(82, 63, 105, 0.05);
    }
    .fc-theme-standard td, .fc-theme-standard th {
        border-color: #eff2f5;
    }
    .fc-col-header-cell-cushion {
        color: #181C32;
        font-weight: 600;
    }
    .fc-daygrid-day-number {
        color: #5E6278;
    }
    .fc-button-primary {
        background-color: var(--teal-500) !important;
        border-color: var(--teal-500) !important;
        color: #ffffff !important;
    }
    .fc-button-primary:hover {
        background-color: var(--teal-600) !important;
        border-color: var(--teal-600) !important;
    }
    .fc-button-active {
        background-color: var(--teal-700) !important;
        border-color: var(--teal-700) !important;
        color: #ffffff !important;
    }
    .fc-button-active:hover {
        background-color: var(--teal-800) !important;
        border-color: var(--teal-800) !important;
    }
    .fc-daygrid-event {
        border-radius: 4px;
        padding: 2px 4px;
    }
    .fc-h-event .fc-event-title {
        font-weight: 500;
        font-size: 0.85rem;
    }
    .fc-day-today {
        background-color: rgba(20, 184, 166, 0.1) !important;
    }
    .legend-item {
        display: inline-flex;
        align-items: center;
        margin-right: 15px;
        margin-bottom: 5px;
    }
    .legend-color {
        width: 12px;
        height: 12px;
        border-radius: 2px;
        margin-right: 5px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <h2><i class="fas fa-calendar-alt text-primary"></i> Appointment Calendar</h2>
                <div class="btn-group" role="group">
                    {% if user.is_doctor or user.is_receptionist or user.is_admin_user %}
                    <a href="{% url 'core:appointment-create' %}" class="btn btn-primary">
                        <i class="fas fa-plus"></i> New Appointment
                    </a>
                    {% endif %}
                    <a href="{% url 'core:appointment-list' %}" class="btn btn-outline-primary">
                        <i class="fas fa-list"></i> List View
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Legend -->
    <div class="row mb-3">
        <div class="col-12">
            <div class="card">
                <div class="card-body py-3">
                    <h6 class="mb-2">Legend:</h6>
                    <div class="d-flex flex-wrap">
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: #14b8a6;"></div>
                            <span>Scheduled</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: #22c55e;"></div>
                            <span>Completed</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: #ef4444;"></div>
                            <span>Cancelled</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: #f59e0b;"></div>
                            <span>Pending</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Calendar -->
    <div class="row">
        <div class="col-12">
            <div class="card calendar-container">
                <div class="card-body">
                    <div id="calendar"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Appointment Modal -->
<div class="modal fade" id="appointmentModal" tabindex="-1" aria-labelledby="appointmentModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="appointmentModalLabel">Appointment Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="appointmentDetails">
                    <!-- Appointment details will be loaded here -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <a href="#" id="viewAppointmentBtn" class="btn btn-primary">View Full Details</a>
                {% if user.is_doctor or user.is_receptionist or user.is_admin_user %}
                <a href="#" id="editAppointmentBtn" class="btn btn-warning">Edit</a>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.10.1/main.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    var calendarEl = document.getElementById('calendar');
    var calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        height: 'auto',
        headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: 'dayGridMonth,timeGridWeek,timeGridDay'
        },
        events: '{% url "calendar-events" %}',
        eventClick: function(info) {
            showAppointmentModal(info.event);
        },
        eventClassNames: function(arg) {
            return ['fc-event-' + arg.event.extendedProps.status];
        },
        eventColor: function(event) {
            switch(event.extendedProps.status) {
                case 'planned': return '#14b8a6';
                case 'completed': return '#22c55e';
                case 'cancelled': return '#ef4444';
                default: return '#f59e0b';
            }
        },
        dayCellClassNames: function(date) {
            var today = new Date();
            if (date.date.toDateString() === today.toDateString()) {
                return ['fc-day-today'];
            }
            return [];
        }
    });
    
    calendar.render();
    
    function showAppointmentModal(event) {
        var modal = new bootstrap.Modal(document.getElementById('appointmentModal'));
        var appointmentId = event.id;
        
        // Update modal content
        document.getElementById('appointmentModalLabel').textContent = 'Appointment: ' + event.title;
        
        var detailsHtml = `
            <div class="row">
                <div class="col-md-6">
                    <strong>Date:</strong> ${event.start.toLocaleDateString()}
                </div>
                <div class="col-md-6">
                    <strong>Time:</strong> ${event.start.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}
                </div>
            </div>
            <div class="row mt-2">
                <div class="col-md-6">
                    <strong>Patient:</strong> ${event.extendedProps.patient || 'N/A'}
                </div>
                <div class="col-md-6">
                    <strong>Doctor:</strong> ${event.extendedProps.doctor || 'N/A'}
                </div>
            </div>
            <div class="row mt-2">
                <div class="col-md-6">
                    <strong>Status:</strong> 
                    <span class="badge bg-${getStatusColor(event.extendedProps.status)}">${getStatusText(event.extendedProps.status)}</span>
                </div>
                <div class="col-md-6">
                    <strong>Duration:</strong> ${event.extendedProps.duration || '30'} minutes
                </div>
            </div>
            ${event.extendedProps.description ? `
            <div class="row mt-2">
                <div class="col-12">
                    <strong>Description:</strong><br>
                    ${event.extendedProps.description}
                </div>
            </div>
            ` : ''}
        `;
        
        document.getElementById('appointmentDetails').innerHTML = detailsHtml;
        
        // Update action buttons
        document.getElementById('viewAppointmentBtn').href = `/core/appointments/${appointmentId}/`;
        {% if user.is_doctor or user.is_receptionist or user.is_admin_user %}
        document.getElementById('editAppointmentBtn').href = `/core/appointments/${appointmentId}/update/`;
        {% endif %}
        
        modal.show();
    }
    
    function getStatusColor(status) {
        switch(status) {
            case 'planned': return 'primary';
            case 'completed': return 'success';
            case 'cancelled': return 'danger';
            default: return 'warning';
        }
    }
    
    function getStatusText(status) {
        switch(status) {
            case 'planned': return 'Scheduled';
            case 'completed': return 'Completed';
            case 'cancelled': return 'Cancelled';
            default: return 'Pending';
        }
    }
});
</script>
{% endblock %}