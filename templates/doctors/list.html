{% extends 'base.html' %}

{% load static %}

{% block title %}
    Doctors
{% endblock %}

{% block content %}

    <!-- Breadcrumb -->
    <div class="bg-light py-3 mb-4">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-8 col-12">
                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb mb-0 bg-transparent">
                            <li class="breadcrumb-item"><a href="{% url 'core:index' %}" class="text-decoration-none">Home</a></li>
                            <li class="breadcrumb-item active" aria-current="page">Doctors</li>
                        </ol>
                    </nav>
                    {% if search_query %}
                        <h4 class="mt-2 text-primary">{{ doctors.count }} matches found for: {{ search_query }}</h4>
                    {% endif %}
                </div>
                <div class="col-md-4 col-12 d-md-block d-none">
                    <div class="d-flex align-items-center justify-content-md-end">
                        <label for="sortSelect" class="me-2 mb-0">Sort by:</label>
                        <select class="form-select" id="sortSelect" name="sort" onchange="updateSort(this.value)">
                            <option value="">Select</option>
                            <option value="price_low" {% if request.GET.sort == 'price_low' %}selected{% endif %}>Price - Low to High</option>
                            <option value="price_high" {% if request.GET.sort == 'price_high' %}selected{% endif %}>Price - High to Low</option>
                            <option value="experience" {% if request.GET.sort == 'experience' %}selected{% endif %}>Experience</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- /Breadcrumb -->

    <!-- Page Content -->
    <div class="container py-4">
        <div class="row g-4">
            <div class="col-lg-4">
                <!-- Search Filter -->
                <form method="get" action="{% url 'doctors:list' %}" class="card shadow-sm">
                    <div class="card-header bg-white">
                        <h5 class="card-title mb-0">Search Filter</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-4">
                            <h6 class="fw-bold mb-3">Gender</h6>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="male" name="gender" value="male" 
                                    {% if 'male' in request.GET.gender %}checked{% endif %}>
                                <label class="form-check-label" for="male">
                                    Male Doctor
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="female" name="gender" value="female" 
                                    {% if 'female' in request.GET.gender %}checked{% endif %}>
                                <label class="form-check-label" for="female">
                                    Female Doctor
                                </label>
                            </div>
                        </div>
                        
                        <div class="mb-4">
                            <h6 class="fw-bold mb-3">Select Specialist</h6>
                            {% for specialization in specializations %}
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" id="spec{{ forloop.counter }}" 
                                        name="specialization" value="{{ specialization }}" 
                                        {% if specialization in request.GET.specialization %}checked{% endif %}>
                                    <label class="form-check-label" for="spec{{ forloop.counter }}">
                                        {{ specialization }}
                                    </label>
                                </div>
                            {% endfor %}
                        </div>
                        
                        <button type="submit" class="btn btn-primary w-100">
                            <i class="fas fa-search me-2"></i> Search
                        </button>
                    </div>
                </form>
                <!-- /Search Filter -->
            </div>

            <div class="col-lg-8">
                {% if doctors %}
                    <div class="row g-4">
                        {% for doctor in doctors %}
                            <!-- Doctor Card -->
                            <div class="col-md-6">
                                <div class="card shadow-sm h-100 doctor-card border-0 rounded-3 overflow-hidden">
                                    <div class="row g-0">
                                        <div class="col-md-12">
                                            <div class="card-body d-flex flex-column h-100">
                                                <div class="d-flex align-items-center mb-3">
                                                    <div class="me-3">
                                                        {% if doctor.profile.image %}
                                                            <img src="{{ doctor.profile.image }}" class="rounded-circle" width="60" height="60" alt="{{ doctor.get_full_name }}" style="object-fit: cover;">
                                                        {% else %}
                                                            <img src="{% static 'assets/img/user.png' %}" class="rounded-circle" width="60" height="60" alt="{{ doctor.get_full_name }}" style="object-fit: cover;">
                                                        {% endif %}
                                                        {% if doctor.profile.is_available %}
                                                            <span class="position-absolute translate-middle badge bg-success" style="margin-left: -15px; margin-top: 40px;">
                                                                <i class="fas fa-check-circle"></i>
                                                            </span>
                                                        {% endif %}
                                                    </div>
                                                    <div>
                                                        <h5 class="card-title mb-1">
                                                            <a href="{% url 'doctors:doctor-profile' doctor.username %}" class="text-decoration-none text-dark">
                                                                Dr. {{ doctor.get_full_name }}
                                                            </a>
                                                        </h5>
                                                        <span class="badge bg-primary-subtle text-primary">{{ doctor.profile.specialization }}</span>
                                                    </div>
                                                </div>
                                                
                                                <div class="mb-2">
                                                    <div class="d-flex align-items-center">
                                                        <span class="text-warning">
                                                            <i class="fas fa-star {% if doctor.rating >= 1 %}filled{% endif %}"></i>
                                                            <i class="fas fa-star {% if doctor.rating >= 2 %}filled{% endif %}"></i>
                                                            <i class="fas fa-star {% if doctor.rating >= 3 %}filled{% endif %}"></i>
                                                            <i class="fas fa-star {% if doctor.rating >= 4 %}filled{% endif %}"></i>
                                                            <i class="fas fa-star {% if doctor.rating >= 5 %}filled{% endif %}"></i>
                                                        </span>
                                                        <span class="ms-1 text-muted small">({{ doctor.reviews_count|default:0 }} reviews)</span>
                                                    </div>
                                                </div>
                                                
                                                <div class="doctor-details mb-3 small">
                                                    <div class="d-flex align-items-center mb-1">
                                                        <i class="fas fa-map-marker-alt me-2 text-primary"></i>
                                                        <span>{{ doctor.profile.city }}{% if doctor.profile.state %}, {{ doctor.profile.state }}{% endif %}</span>
                                                    </div>
                                                    <div class="d-flex align-items-center mb-1">
                                                        <i class="far fa-money-bill-alt me-2 text-success"></i>
                                                        <span class="fw-bold">à§³{{ doctor.profile.price_per_consultation }}</span>
                                                        <span class="ms-1 text-muted">(Consultation Fee)</span>
                                                    </div>
                                                    <div class="d-flex align-items-center">
                                                        <i class="fas fa-phone me-2 text-info"></i>
                                                        <span>{{ doctor.profile.phone|default:"Contact via booking" }}</span>
                                                    </div>
                                                </div>
                                                
                                                <div class="doctor-action mt-auto d-flex gap-2">
                                                    <a href="{% url 'doctors:doctor-profile' doctor.username %}" class="btn btn-outline-primary btn-sm flex-grow-1">
                                                        <i class="fas fa-user-md me-1"></i> View Profile
                                                    </a>
                                                    <a href="{% url 'bookings:doctor-booking-view' doctor.username %}" class="btn btn-primary btn-sm flex-grow-1">
                                                        <i class="fas fa-calendar-check me-1"></i> Book Now
                                                    </a>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- /Doctor Card -->
                        {% endfor %}
                    </div>

                    {% if is_paginated %}
                    <div class="row mt-5">
                        <div class="col-12">
                            <nav aria-label="Page navigation">
                                <ul class="pagination justify-content-center">
                                    {% if page_obj.has_previous %}
                                        <li class="page-item">
                                            <a class="page-link" href="?{% if request.GET.q %}q={{ request.GET.q }}&{% endif %}{% if request.GET.sort %}sort={{ request.GET.sort }}&{% endif %}page={{ page_obj.previous_page_number }}" aria-label="Previous">
                                                <span aria-hidden="true">&laquo;</span>
                                            </a>
                                        </li>
                                    {% else %}
                                        <li class="page-item disabled">
                                            <a class="page-link" href="#" aria-label="Previous">
                                                <span aria-hidden="true">&laquo;</span>
                                            </a>
                                        </li>
                                    {% endif %}

                                    {% for num in page_obj.paginator.page_range %}
                                        {% if page_obj.number == num %}
                                            <li class="page-item active"><a class="page-link" href="#">{{ num }}</a></li>
                                        {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                                            <li class="page-item">
                                                <a class="page-link" href="?{% if request.GET.q %}q={{ request.GET.q }}&{% endif %}{% if request.GET.sort %}sort={{ request.GET.sort }}&{% endif %}page={{ num }}">{{ num }}</a>
                                            </li>
                                        {% endif %}
                                    {% endfor %}

                                    {% if page_obj.has_next %}
                                        <li class="page-item">
                                            <a class="page-link" href="?{% if request.GET.q %}q={{ request.GET.q }}&{% endif %}{% if request.GET.sort %}sort={{ request.GET.sort }}&{% endif %}page={{ page_obj.next_page_number }}" aria-label="Next">
                                                <span aria-hidden="true">&raquo;</span>
                                            </a>
                                        </li>
                                    {% else %}
                                        <li class="page-item disabled">
                                            <a class="page-link" href="#" aria-label="Next">
                                                <span aria-hidden="true">&raquo;</span>
                                            </a>
                                        </li>
                                    {% endif %}
                                </ul>
                            </nav>
                        </div>
                    </div>
                    {% endif %}
                {% else %}
                    <div class="card shadow-sm">
                        <div class="card-body text-center py-5">
                            <i class="fas fa-user-md text-muted mb-3" style="font-size: 3rem;"></i>
                            <h4 class="mb-3">No doctors found</h4>
                            <p class="text-muted mb-4">No doctors found matching your criteria. Try adjusting your filters.</p>
                            <a href="{% url 'doctors:list' %}" class="btn btn-primary">
                                <i class="fas fa-sync-alt me-2"></i> Reset Filters
                            </a>
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
    <!-- /Page Content -->

{% endblock %}

{% block scripts %}
<script>
    function updateSort(value) {
        // Get current URL and parameters
        const url = new URL(window.location.href);
        const params = new URLSearchParams(url.search);
        
        // Update or add sort parameter
        if (value) {
            params.set('sort', value);
        } else {
            params.delete('sort');
        }
        
        // Redirect with updated parameters
        window.location.href = `${url.pathname}?${params.toString()}`;
    }

    $(document).ready(function() {
        $('[data-bs-toggle="tooltip"]').tooltip();
    });
</script>
{% endblock %}