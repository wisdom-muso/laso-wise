{% extends 'base.html' %}
{% load static %}
{% load i18n %}

{% block title %}{% trans "System Sync & Monitoring" %}{% endblock %}

{% block styles %}
<style>
    .status-indicator {
        width: 15px;
        height: 15px;
        border-radius: 50%;
        display: inline-block;
        margin-right: 5px;
    }
    
    .status-healthy {
        background-color: #28a745;
    }
    
    .status-warning {
        background-color: #ffc107;
    }
    
    .status-critical {
        background-color: #dc3545;
    }
    
    .status-unknown {
        background-color: #6c757d;
    }
    
    .status-pending {
        background-color: #17a2b8;
    }
    
    .status-in_progress {
        background-color: #14b8a6;
    }
    
    .status-completed {
        background-color: #28a745;
    }
    
    .status-failed {
        background-color: #dc3545;
    }
    
    .component-card {
        border-radius: 10px;
        overflow: hidden;
        transition: all 0.3s ease;
    }
    
    .component-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0,0,0,0.1);
    }
    
    .component-card .card-header {
        padding: 15px;
    }
    
    .component-card .card-body {
        padding: 20px;
    }
    
    .sync-stats-card {
        text-align: center;
        border-radius: 10px;
        overflow: hidden;
    }
    
    .sync-stats-card .card-body {
        padding: 20px;
    }
    
    .sync-stats-card .stat-value {
        font-size: 2rem;
        font-weight: bold;
    }
    
    .sync-stats-card .stat-label {
        font-size: 0.9rem;
        color: #6c757d;
    }
    
    .chart-container {
        height: 300px;
    }
    
    .progress-bar-animated {
        animation: progress-bar-stripes 1s linear infinite;
    }
</style>
{% endblock %}

{% block content %}
<div class="breadcrumb-bar">
    <div class="container-fluid">
        <div class="row align-items-center">
            <div class="col-md-12 col-12">
                <nav aria-label="breadcrumb" class="page-breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="{% url 'admin-dashboard' %}">{% trans "Dashboard" %}</a></li>
                        <li class="breadcrumb-item active" aria-current="page">{% trans "System Sync & Monitoring" %}</li>
                    </ol>
                </nav>
                <h2 class="breadcrumb-title">{% trans "System Sync & Monitoring" %}</h2>
            </div>
        </div>
    </div>
</div>

<div class="content">
    <div class="container-fluid">
        <!-- System Health Overview -->
        <div class="row">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <h4 class="card-title">{% trans "System Health Overview" %}</h4>
                        <div class="card-tools">
                            <form method="post" action="{% url 'sync_monitor:health_check' %}" class="d-inline">
                                {% csrf_token %}
                                <input type="hidden" name="check_type" value="overall">
                                <button type="submit" class="btn btn-sm btn-primary">
                                    <i class="fas fa-sync-alt"></i> {% trans "Run Health Check" %}
                                </button>
                            </form>
                            <a href="{% url 'sync_monitor:health_history' %}" class="btn btn-sm btn-info ml-2">
                                <i class="fas fa-history"></i> {% trans "View History" %}
                            </a>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            {% for component, data in component_health.items %}
                            <div class="col-md-4 mb-4">
                                <div class="card component-card">
                                    <div class="card-header bg-light d-flex justify-content-between align-items-center">
                                        <h5 class="mb-0">
                                            <span class="status-indicator status-{{ data.status }}"></span>
                                            {% if component == 'database' %}
                                                <i class="fas fa-database"></i>
                                            {% elif component == 'api' %}
                                                <i class="fas fa-plug"></i>
                                            {% elif component == 'storage' %}
                                                <i class="fas fa-hdd"></i>
                                            {% elif component == 'cache' %}
                                                <i class="fas fa-memory"></i>
                                            {% elif component == 'queue' %}
                                                <i class="fas fa-exchange-alt"></i>
                                            {% endif %}
                                            {{ component|title }}
                                        </h5>
                                        <form method="post" action="{% url 'sync_monitor:health_check' %}" class="d-inline">
                                            {% csrf_token %}
                                            <input type="hidden" name="check_type" value="{{ component }}">
                                            <button type="submit" class="btn btn-sm btn-outline-primary">
                                                <i class="fas fa-sync-alt"></i>
                                            </button>
                                        </form>
                                    </div>
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between mb-2">
                                            <span>{% trans "Status" %}:</span>
                                            <span class="font-weight-bold text-{{ data.status }}">
                                                {{ data.status|title }}
                                            </span>
                                        </div>
                                        <div class="d-flex justify-content-between mb-2">
                                            <span>{% trans "Response Time" %}:</span>
                                            <span>{{ data.response_time|floatformat:2 }} ms</span>
                                        </div>
                                        <div class="d-flex justify-content-between">
                                            <span>{% trans "Last Check" %}:</span>
                                            <span>
                                                {% if data.checked_at %}
                                                    {{ data.checked_at|date:"M d, Y H:i" }}
                                                {% else %}
                                                    {% trans "Never" %}
                                                {% endif %}
                                            </span>
                                        </div>
                                        {% if data.details %}
                                        <div class="mt-3">
                                            <small class="text-muted">{{ data.details }}</small>
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sync Statistics -->
        <div class="row">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <h4 class="card-title">{% trans "Sync Statistics" %}</h4>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-2 mb-3">
                                <div class="card sync-stats-card">
                                    <div class="card-body">
                                        <div class="stat-value">{{ sync_stats.total }}</div>
                                        <div class="stat-label">{% trans "Total Syncs" %}</div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-2 mb-3">
                                <div class="card sync-stats-card bg-success-light">
                                    <div class="card-body">
                                        <div class="stat-value">{{ sync_stats.completed }}</div>
                                        <div class="stat-label">{% trans "Completed" %}</div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-2 mb-3">
                                <div class="card sync-stats-card bg-danger-light">
                                    <div class="card-body">
                                        <div class="stat-value">{{ sync_stats.failed }}</div>
                                        <div class="stat-label">{% trans "Failed" %}</div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-2 mb-3">
                                <div class="card sync-stats-card bg-primary-light">
                                    <div class="card-body">
                                        <div class="stat-value">{{ sync_stats.in_progress }}</div>
                                        <div class="stat-label">{% trans "In Progress" %}</div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-2 mb-3">
                                <div class="card sync-stats-card bg-info-light">
                                    <div class="card-body">
                                        <div class="stat-value">{{ sync_stats.pending }}</div>
                                        <div class="stat-label">{% trans "Pending" %}</div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-2 mb-3">
                                <div class="card sync-stats-card">
                                    <div class="card-body">
                                        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#triggerSyncModal">
                                            <i class="fas fa-sync-alt"></i> {% trans "Trigger Sync" %}
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sync History Chart -->
        <div class="row">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <h4 class="card-title">{% trans "Sync History (Last 30 Days)" %}</h4>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="syncHistoryChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Latest Sync Operations -->
        <div class="row">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <h4 class="card-title">{% trans "Latest Sync Operations" %}</h4>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover table-center mb-0">
                                <thead>
                                    <tr>
                                        <th>{% trans "Type" %}</th>
                                        <th>{% trans "Status" %}</th>
                                        <th>{% trans "Started" %}</th>
                                        <th>{% trans "Completed" %}</th>
                                        <th>{% trans "Duration" %}</th>
                                        <th>{% trans "Records" %}</th>
                                        <th>{% trans "Success Rate" %}</th>
                                        <th>{% trans "Actions" %}</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for sync in sync_operations %}
                                    <tr>
                                        <td>{{ sync.get_sync_type_display }}</td>
                                        <td>
                                            <span class="status-indicator status-{{ sync.status }}"></span>
                                            {{ sync.get_status_display }}
                                            {% if sync.status == 'in_progress' %}
                                            <div class="progress mt-1" style="height: 5px;">
                                                <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 100%"></div>
                                            </div>
                                            {% endif %}
                                        </td>
                                        <td>{{ sync.started_at|date:"M d, Y H:i" }}</td>
                                        <td>
                                            {% if sync.completed_at %}
                                                {{ sync.completed_at|date:"M d, Y H:i" }}
                                            {% else %}
                                                -
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if sync.duration %}
                                                {{ sync.duration }}
                                            {% else %}
                                                -
                                            {% endif %}
                                        </td>
                                        <td>
                                            {{ sync.records_processed }}
                                            {% if sync.records_failed > 0 %}
                                                <span class="text-danger">({{ sync.records_failed }} failed)</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if sync.records_processed > 0 %}
                                                <div class="progress" style="height: 5px;">
                                                    <div class="progress-bar bg-success" role="progressbar" style="width: {{ sync.success_rate }}%"></div>
                                                </div>
                                                <small>{{ sync.success_rate }}%</small>
                                            {% else %}
                                                -
                                            {% endif %}
                                        </td>
                                        <td>
                                            <a href="{% url 'sync_monitor:sync_detail' sync.id %}" class="btn btn-sm btn-info">
                                                <i class="fas fa-eye"></i>
                                            </a>
                                        </td>
                                    </tr>
                                    {% empty %}
                                    <tr>
                                        <td colspan="8" class="text-center">{% trans "No sync operations found" %}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Pagination -->
                        {% if is_paginated %}
                        <div class="row mt-4">
                            <div class="col-md-12">
                                <nav aria-label="Page navigation">
                                    <ul class="pagination justify-content-center">
                                        {% if page_obj.has_previous %}
                                        <li class="page-item">
                                            <a class="page-link" href="?page=1">&laquo; {% trans "First" %}</a>
                                        </li>
                                        <li class="page-item">
                                            <a class="page-link" href="?page={{ page_obj.previous_page_number }}">{% trans "Previous" %}</a>
                                        </li>
                                        {% endif %}
                                        
                                        {% for num in page_obj.paginator.page_range %}
                                            {% if page_obj.number == num %}
                                            <li class="page-item active">
                                                <span class="page-link">{{ num }}</span>
                                            </li>
                                            {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                                            <li class="page-item">
                                                <a class="page-link" href="?page={{ num }}">{{ num }}</a>
                                            </li>
                                            {% endif %}
                                        {% endfor %}
                                        
                                        {% if page_obj.has_next %}
                                        <li class="page-item">
                                            <a class="page-link" href="?page={{ page_obj.next_page_number }}">{% trans "Next" %}</a>
                                        </li>
                                        <li class="page-item">
                                            <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}">{% trans "Last" %} &raquo;</a>
                                        </li>
                                        {% endif %}
                                    </ul>
                                </nav>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Trigger Sync Modal -->
<div class="modal fade" id="triggerSyncModal" tabindex="-1" aria-labelledby="triggerSyncModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="triggerSyncModalLabel">{% trans "Trigger Sync Operation" %}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="post" action="{% url 'sync_monitor:trigger_sync' %}">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="form-group">
                        <label for="sync_type">{% trans "Sync Type" %}</label>
                        <select class="form-select" id="sync_type" name="sync_type" required>
                            <option value="">{% trans "Select Sync Type" %}</option>
                            <option value="patient_data">{% trans "Patient Data" %}</option>
                            <option value="doctor_data">{% trans "Doctor Data" %}</option>
                            <option value="appointment_data">{% trans "Appointment Data" %}</option>
                            <option value="prescription_data">{% trans "Prescription Data" %}</option>
                            <option value="vital_data">{% trans "Vital Signs Data" %}</option>
                            <option value="hospital_data">{% trans "Hospital Data" %}</option>
                            <option value="full_sync">{% trans "Full System Sync" %}</option>
                        </select>
                    </div>
                    <div class="alert alert-info mt-3">
                        <i class="fas fa-info-circle"></i> {% trans "Triggering a sync operation will synchronize data between the platform and external systems. This may take some time depending on the amount of data." %}
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% trans "Cancel" %}</button>
                    <button type="submit" class="btn btn-primary">{% trans "Trigger Sync" %}</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    $(document).ready(function() {
        // Initialize chart
        var ctx = document.getElementById('syncHistoryChart').getContext('2d');
        var chartData = {{ chart_data|safe }};
        
        var syncHistoryChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: chartData.labels,
                datasets: [
                    {
                        label: '{% trans "Completed" %}',
                        data: chartData.completed,
                        backgroundColor: 'rgba(40, 167, 69, 0.7)',
                        borderColor: 'rgba(40, 167, 69, 1)',
                        borderWidth: 1
                    },
                    {
                        label: '{% trans "Failed" %}',
                        data: chartData.failed,
                        backgroundColor: 'rgba(220, 53, 69, 0.7)',
                        borderColor: 'rgba(220, 53, 69, 1)',
                        borderWidth: 1
                    },
                    {
                        label: '{% trans "In Progress" %}',
                        data: chartData.in_progress,
                        backgroundColor: 'rgba(0, 123, 255, 0.7)',
                        borderColor: 'rgba(0, 123, 255, 1)',
                        borderWidth: 1
                    },
                    {
                        label: '{% trans "Pending" %}',
                        data: chartData.pending,
                        backgroundColor: 'rgba(23, 162, 184, 0.7)',
                        borderColor: 'rgba(23, 162, 184, 1)',
                        borderWidth: 1
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        stacked: true
                    },
                    y: {
                        stacked: true,
                        beginAtZero: true,
                        ticks: {
                            precision: 0
                        }
                    }
                }
            }
        });
        
        // Real-time updates for in-progress syncs and health status
        function updateRealTimeData() {
            $.ajax({
                url: '{% url "sync_monitor:health_api" %}',
                type: 'GET',
                dataType: 'json',
                success: function(data) {
                    // Update component health status
                    for (var component in data.components) {
                        var componentData = data.components[component];
                        var statusClass = 'status-' + componentData.status;
                        
                        // Update status indicator
                        $('.component-card h5:contains("' + component.charAt(0).toUpperCase() + component.slice(1) + '") .status-indicator')
                            .removeClass('status-healthy status-warning status-critical status-unknown')
                            .addClass(statusClass);
                        
                        // Update status text
                        $('.component-card h5:contains("' + component.charAt(0).toUpperCase() + component.slice(1) + '")')
                            .closest('.card-header')
                            .next('.card-body')
                            .find('.text-healthy, .text-warning, .text-critical, .text-unknown')
                            .removeClass('text-healthy text-warning text-critical text-unknown')
                            .addClass('text-' + componentData.status)
                            .text(componentData.status.charAt(0).toUpperCase() + componentData.status.slice(1));
                    }
                    
                    // Update in-progress syncs
                    // This would be more complex in a real implementation
                },
                complete: function() {
                    // Schedule the next update
                    setTimeout(updateRealTimeData, 10000); // Update every 10 seconds
                }
            });
        }
        
        // Start real-time updates
        updateRealTimeData();
    });
</script>
{% endblock %}